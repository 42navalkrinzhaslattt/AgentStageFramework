<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presidential Simulator - Chat Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .chat-container {
            width: 95%;
            max-width: 900px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .game-info {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .turn-counter {
            font-weight: 600;
            color: #2c3e50;
        }

        .metrics {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .metric {
            padding: 4px 8px;
            border-radius: 12px;
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .event-message {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(238, 90, 82, 0.3);
        }

        .event-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .event-description {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .severity {
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .advisor-message {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .advisor-name {
            font-weight: 600;
            color: #007bff;
            margin-bottom: 8px;
        }

        .advisor-advice {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .advisor-recommendation {
            font-size: 12px;
            color: #28a745;
            font-weight: 500;
        }

        .options-container {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .options-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .option-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-align: left;
        }

        .option-button:hover {
            border-color: #007bff;
            background: #f0f8ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
        }

        .input-container {
            background: white;
            border: 2px solid #007bff;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .input-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .response-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .response-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .submit-button {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .suggested-options {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .suggested-options h4 {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
            text-align: center;
        }

        .quick-option {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            margin: 4px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-option:hover {
            background: #bbdefb;
            transform: translateY(-1px);
        }

        .player-message {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px 15px 5px 15px;
            margin: 10px 0 20px auto;
            max-width: 80%;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }

        .player-name {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
            text-align: right;
        }

        .player-text {
            font-size: 14px;
            line-height: 1.4;
        }

        .decision-result {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .result-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .consequence-text {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 13px;
            line-height: 1.4;
            border-left: 4px solid rgba(255, 255, 255, 0.3);
        }

        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .impact-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #6c757d;
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: #6c757d; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 #6c757d, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 #6c757d, .5em 0 0 #6c757d; }
        }

        .game-complete {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .final-score {
            font-size: 48px;
            font-weight: 700;
            margin: 15px 0;
        }

        .restart-button {
            background: white;
            color: #6f42c1;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .restart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .header {
                border-radius: 0;
            }
            
            .metrics {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .impact-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h1>🏛️ Presidential Simulator</h1>
            <div class="subtitle">Turn-Based Decision Making Game</div>
        </div>
        
        <div class="game-info">
            <div class="turn-counter">Turn <span id="current-turn">1</span> of 5</div>
            <div class="metrics">
                <div class="metric">Economy: <span id="economy">0</span></div>
                <div class="metric">Security: <span id="security">0</span></div>
                <div class="metric">Diplomacy: <span id="diplomacy">0</span></div>
                <div class="metric">Environment: <span id="environment">0</span></div>
                <div class="metric">Approval: <span id="approval">50</span></div>
                <div class="metric">Stability: <span id="stability">50</span></div>
            </div>
        </div>

        <div class="chat-messages" id="messages">
            <div class="message">
                <div class="event-message">
                    <div class="event-title">🏛️ Welcome, Mr./Madam President</div>
                    <div class="event-description">
                        You are about to begin your presidency. Over the next 5 critical turns, you will face major national crises that require immediate decisions. Each turn, you'll receive briefings from 3 of your 8 advisors, then make choices that will impact the nation and your legacy.
                    </div>
                    <div class="severity">Your first crisis is being prepared...</div>
                </div>
            </div>
        </div>
        
        <div class="options-container" id="options-container" style="display: none;">
            <div class="options-title">🎯 Your Decision</div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            turn: 1,
            maxTurns: 5,
            metrics: {
                economy: 50,
                security: 50,
                diplomacy: 50,
                environment: 50,
                approval: 50,
                stability: 50
            },
            currentEvent: null,
            advisors: [],
            history: []
        };

        async function startGame() {
            addLoadingMessage("Initializing your presidency...");
            
            try {
                // Call the backend to start a new game
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const gameData = await response.json();
                
                // Update local game state
                gameState.turn = gameData.turn;
                gameState.metrics = gameData.metrics;
                
                // Update UI
                updateMetricsDisplay();
                updateTurnCounter();
                
                removeLastMessage();
                
                // Start the first turn
                startNewTurn();
                
            } catch (error) {
                console.error('Failed to start game:', error);
                removeLastMessage();
                addErrorMessage('Failed to connect to game server. Please refresh and try again.');
            }
        }

        // Auto-start the game when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                startGame();
            }, 1500);
        });

        async function startNewTurn() {
            if (gameState.turn > gameState.maxTurns) {
                endGame();
                return;
            }

            addLoadingMessage("Generating your next crisis...");
            
            try {
                // Call the backend to start a new turn
                const response = await fetch('/api/new-turn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const turnData = await response.json();
                
                removeLastMessage();
                
                // Update game state
                gameState.currentEvent = turnData.event;
                gameState.advisors = turnData.advisors;
                
                // Display the event
                displayEvent(turnData.event);
                
                // Display advisor responses
                setTimeout(() => {
                    displayAdvisorResponses(turnData.advisors, turnData.event);
                }, 1000);
                
            } catch (error) {
                console.error('Failed to start new turn:', error);
                removeLastMessage();
                addErrorMessage('Failed to generate new crisis. Please refresh and try again.');
            }
        }

        function displayEvent(event) {
            const messagesContainer = document.getElementById('messages');
            
            const eventDiv = document.createElement('div');
            eventDiv.className = 'message';
            eventDiv.innerHTML = `
                <div class="event-message">
                    <div class="event-title">${event.title}</div>
                    <div class="event-description">${event.description}</div>
                </div>
            `;
            
            messagesContainer.appendChild(eventDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function selectRandomAdvisors(count) {
            const shuffled = [...advisors].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function displayAdvisorResponses(selectedAdvisors, event) {
            const messagesContainer = document.getElementById('messages');
            
            addLoadingMessage("Your advisors are analyzing the situation");
            
            setTimeout(() => {
                removeLastMessage(); // Remove loading message
                
                selectedAdvisors.forEach((advisor, index) => {
                    setTimeout(() => {
                        const advice = generateAdvice(advisor, event);
                        const advisorDiv = document.createElement('div');
                        advisorDiv.className = 'message';
                        advisorDiv.innerHTML = `
                            <div class="advisor-message">
                                <div class="advisor-name">👤 ${advisor.name} (${advisor.title})</div>
                                <div class="advisor-advice">${advice.text}</div>
                            </div>
                        `;
                        messagesContainer.appendChild(advisorDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, index * 1000);
                });

                setTimeout(() => {
                    displayOptions(event);
                }, selectedAdvisors.length * 1000 + 500);
            }, 2000);
        }

        function generateAdvice(advisor, event) {
            // Generate advice based on advisor specialty and event category
            const advisorAdvice = {
                // Secretary of State - Diplomacy focused
                "sec_state": {
                    politics: "Political crises require careful diplomatic navigation both domestically and internationally. Our allies are watching how we handle internal governance challenges. I recommend transparent communication with international partners about our democratic processes while maintaining stable foreign relationships.",
                    war: "Military conflicts demand coordinated international response and alliance management. We must balance our security commitments with diplomatic solutions. Consider how military actions affect our relationships with allies and neutral nations, and seek multilateral approaches when possible.",
                    immigration: "Immigration issues significantly impact our relationships with neighboring countries and our global reputation. We should coordinate with international organizations and source countries to address root causes while maintaining humanitarian leadership globally.",
                    tech: "Technology policies increasingly affect international relations and economic partnerships. We need to balance national security concerns with maintaining beneficial tech cooperation with allies. Consider how regulations might affect our competitive position globally.",
                    economy: "Economic instability can affect international trade relationships and our global leadership position. Coordinate with international economic institutions and major trading partners to prevent broader economic disruption while protecting American interests.",
                    corruption: "Corruption allegations damage our international credibility and soft power. Transparent handling of these issues demonstrates American democratic values to the world. International partners need confidence in our institutional integrity.",
                    environment: "Environmental crises require international coordination and demonstrate our commitment to global climate leadership. This is an opportunity to strengthen partnerships while addressing domestic needs and showing responsible global citizenship.",
                    health: "Public health emergencies increasingly require international coordination and information sharing. Our response will be closely watched globally and affects our reputation for crisis management and humanitarian leadership."
                },
                
                // Secretary of Defense - Security focused  
                "sec_defense": {
                    politics: "Political instability can affect national security by weakening our decision-making processes and international credibility. We need to ensure political disputes don't compromise our defense capabilities or intelligence operations.",
                    war: "Military conflicts require clear strategic objectives and adequate resources. We must assess our readiness levels, alliance commitments, and potential for escalation. Consider both immediate tactical needs and long-term strategic implications.",
                    immigration: "Immigration and border security are directly related to national security. We need comprehensive approaches that address security concerns while maintaining humanitarian obligations. Border security affects our ability to track potential threats.",
                    tech: "Technology security is critical to our national defense infrastructure. Cyber threats, technology transfers, and critical supply chains all affect our security posture. We must balance innovation with security requirements.",
                    economy: "Economic stability directly affects our defense capabilities through budget constraints and industrial base strength. Economic crises can limit our military readiness and affect our ability to support allies globally.",
                    corruption: "Corruption within government affects military readiness and security operations. Clear ethical standards and transparency are essential for maintaining military effectiveness and public trust in our security institutions.",
                    environment: "Environmental disasters strain military resources through domestic response missions and can create regional instability globally. Climate change increasingly affects military planning and resource allocation.",
                    health: "Health crises can affect military readiness and require military support for civilian authorities. We need to maintain operational capabilities while providing necessary assistance to civilian health authorities."
                },
                
                // Secretary of Treasury - Economy focused
                "sec_treasury": {
                    politics: "Political instability creates market uncertainty and affects investor confidence. We need to demonstrate fiscal responsibility and policy continuity to maintain economic stability and market confidence.",
                    war: "Military operations require significant budget allocations and can affect economic growth through defense spending and market disruption. We need to balance security needs with fiscal responsibility.",
                    immigration: "Immigration policies significantly affect labor markets, economic growth, and fiscal impacts through public services. We need balanced approaches that consider both economic benefits and costs.",
                    tech: "Technology sector health is crucial for economic growth and innovation. Regulations and policies must balance security concerns with maintaining our competitive advantage in global technology markets.",
                    economy: "This directly affects our core responsibilities for fiscal policy, monetary coordination, and financial system stability. We need immediate action to prevent broader economic damage while considering long-term implications.",
                    corruption: "Corruption undermines economic confidence and market stability. Clean governance is essential for maintaining investor confidence and efficient economic function. Transparent processes strengthen economic institutions.",
                    environment: "Environmental policies have significant economic implications through regulations, energy costs, and infrastructure investments. We need to balance environmental goals with economic growth and competitiveness.",
                    health: "Health crises create major economic disruption through healthcare costs, productivity losses, and market uncertainty. We need policies that address both immediate health needs and economic stability."
                },
                
                // Chief of Staff - Political strategy focused
                "chief_staff": {
                    politics: "This crisis directly affects our political capital and relationships with Congress, voters, and key constituencies. We need strategic responses that strengthen our position while addressing legitimate concerns.",
                    war: "Military decisions require careful political coordination with Congress and public communication. Consider how different approaches affect our political coalition and relationships with both parties.",
                    immigration: "Immigration is highly polarizing politically and affects our relationships with different voter groups and regional interests. We need approaches that build rather than divide our political coalition.",
                    tech: "Technology policy affects relationships with major corporations and different demographic groups. Consider how regulations impact key constituencies and our ability to advance other priorities.",
                    economy: "Economic performance directly affects electoral prospects and political effectiveness. Our response must demonstrate competence while building support for broader policy agenda.",
                    corruption: "How we handle corruption allegations affects public trust and political effectiveness. Transparent, decisive action can demonstrate leadership while defensive responses can appear problematic.",
                    environment: "Environmental policies significantly affect different regional and demographic coalitions. We need approaches that build broader support while addressing legitimate environmental concerns.",
                    health: "Health crises test government competence and can significantly affect public approval. Effective responses demonstrate leadership capability while poor handling can undermine political effectiveness."
                }
            };
            
            // Get advice for this advisor and event category, or use default
            const categoryAdvice = advisorAdvice[advisor.id]?.[event.category];
            
            if (categoryAdvice) {
                return {
                    text: categoryAdvice,
                    recommendation: Math.floor(Math.random() * event.options.length)
                };
            }
            
            // Default advice if no specific advice available
            const defaultAdvice = [
                "This situation requires careful analysis of all factors before making a decision. We should consider both immediate and long-term consequences of our response.",
                "Based on my experience, I believe we need to take a measured approach that addresses the root causes of this crisis while managing immediate concerns.",
                "The implications of our response will extend far beyond this immediate situation and could set important precedents for future policy decisions."
            ];
            
            return {
                text: defaultAdvice[Math.floor(Math.random() * defaultAdvice.length)],
                recommendation: Math.floor(Math.random() * event.options.length)
            };
        }

        function displayOptions(event) {
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.style.display = 'block';
            optionsContainer.innerHTML = `
                <div class="input-container">
                    <div class="input-title">🎯 Your Presidential Response</div>
                    <textarea 
                        class="response-input" 
                        id="player-response" 
                        placeholder="Type your decision as President... You can choose from the suggested options below or write your own response. (Press Ctrl+Enter to submit)"
                        maxlength="500"
                        oninput="updateCharCount()"
                    ></textarea>
                    <div style="text-align: right; font-size: 12px; color: #6c757d; margin-bottom: 10px;">
                        <span id="char-count">0</span>/500 characters
                    </div>
                    <button class="submit-button" onclick="submitResponse()">
                        📤 Submit Presidential Decision
                    </button>
                    
                    <div class="suggested-options">
                        <h4>💡 Suggested Options (click to use):</h4>
                        ${event.options.map((option, index) => `
                            <div class="quick-option" onclick="useQuickOption('${option.replace(/'/g, '&apos;')}')">${index + 1}. ${option}</div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Focus on the textarea
            setTimeout(() => {
                const textarea = document.getElementById('player-response');
                textarea.focus();
                
                // Add Enter key support (Ctrl+Enter or Cmd+Enter to submit)
                textarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        submitResponse();
                    }
                });
            }, 100);
        }

        function updateCharCount() {
            const textarea = document.getElementById('player-response');
            const charCount = document.getElementById('char-count');
            if (textarea && charCount) {
                charCount.textContent = textarea.value.length;
            }
        }

        function useQuickOption(option) {
            const textarea = document.getElementById('player-response');
            textarea.value = option;
            updateCharCount();
            textarea.focus();
        }

        function submitResponse() {
            const responseText = document.getElementById('player-response').value.trim();
            if (!responseText) {
                alert('Please enter your presidential decision before submitting.');
                return;
            }

            // Display the player's message in chat format
            displayPlayerMessage(responseText);
            
            // Process the custom response
            makeCustomDecision(responseText);
        }

        function displayPlayerMessage(message) {
            const messagesContainer = document.getElementById('messages');
            
            const playerDiv = document.createElement('div');
            playerDiv.className = 'message';
            playerDiv.innerHTML = `
                <div class="player-message">
                    <div class="player-name">🏛️ President</div>
                    <div class="player-text">${message}</div>
                </div>
            `;
            
            messagesContainer.appendChild(playerDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function makeCustomDecision(responseText) {
            addLoadingMessage(`Processing your presidential decision...`);
            
            setTimeout(() => {
                // Analyze the response and determine which suggested option it's closest to (simple keyword matching)
                const event = gameState.currentEvent;
                let choiceIndex = 0; // Default to first option
                
                // Simple keyword matching to determine intent
                const response = responseText.toLowerCase();
                if (response.includes('attack') || response.includes('counter') || response.includes('retaliate')) {
                    choiceIndex = 0;
                } else if (response.includes('investigate') || response.includes('quietly') || response.includes('defense')) {
                    choiceIndex = 1;
                } else if (response.includes('public') || response.includes('international') || response.includes('support')) {
                    choiceIndex = 2;
                } else if (response.includes('negotiate') || response.includes('diplomatic') || response.includes('private')) {
                    choiceIndex = 3;
                }

                const impact = calculateImpact(event, choiceIndex);
                applyImpact(impact);
                displayDecisionResult(responseText, impact);
                
                gameState.turn++;
                updateTurnCounter();
                
                setTimeout(() => {
                    if (gameState.turn <= gameState.maxTurns) {
                        // Hide options container and automatically start next turn
                        const optionsContainer = document.getElementById('options-container');
                        optionsContainer.style.display = 'none';
                        
                        setTimeout(() => {
                            startNewTurn();
                        }, 2000);
                    } else {
                        endGame();
                    }
                }, 3000);
            }, 2000);
        }

        function makeDecision(choiceIndex) {
            const event = gameState.currentEvent;
            const choice = event.options[choiceIndex];
            
            // Display the player's choice as a message
            displayPlayerMessage(choice);
            
            addLoadingMessage(`Processing your decision: "${choice}"`);
            
            setTimeout(() => {
                const impact = calculateImpact(event, choiceIndex);
                applyImpact(impact);
                displayDecisionResult(choice, impact);
                
                gameState.turn++;
                updateTurnCounter();
                
                setTimeout(() => {
                    if (gameState.turn <= gameState.maxTurns) {
                        // Hide options container and automatically start next turn
                        const optionsContainer = document.getElementById('options-container');
                        optionsContainer.style.display = 'none';
                        
                        setTimeout(() => {
                            startNewTurn();
                        }, 2000);
                    } else {
                        endGame();
                    }
                }, 3000);
            }, 2000);
        }

        function calculateImpact(event, choiceIndex) {
            // Calculate impact based on event category and choice
            let impact = { economy: 0, security: 0, diplomacy: 0, environment: 0, approval: 0, stability: 0 };
            
            // Base impacts by event category and choice index
            const categoryImpacts = {
                politics: [
                    { economy: -1, security: 0, diplomacy: 2, environment: 0, approval: 3, stability: 1 },   // Negotiate/compromise
                    { economy: 0, security: 1, diplomacy: -1, environment: 0, approval: 4, stability: 2 },   // Rally public support
                    { economy: -2, security: 2, diplomacy: -3, environment: 0, approval: -1, stability: -1 }, // Use executive power
                    { economy: 1, security: 0, diplomacy: 3, environment: 0, approval: 1, stability: 3 }    // Seek mediation
                ],
                war: [
                    { economy: -4, security: 6, diplomacy: -2, environment: 0, approval: 2, stability: -1 }, // Military action
                    { economy: -2, security: 3, diplomacy: 2, environment: 0, approval: 1, stability: 1 },  // Support/aid
                    { economy: 1, security: -1, diplomacy: 4, environment: 0, approval: -1, stability: 2 }, // Diplomatic action
                    { economy: 2, security: -2, diplomacy: 1, environment: 0, approval: -2, stability: 0 }  // Negotiate/withdraw
                ],
                immigration: [
                    { economy: -2, security: 1, diplomacy: -1, environment: 0, approval: -1, stability: 0 }, // Restrictive measures
                    { economy: 0, security: 3, diplomacy: 1, environment: 0, approval: 2, stability: 2 },   // Expand capacity
                    { economy: 1, security: 0, diplomacy: 3, environment: 0, approval: 3, stability: 1 },   // International cooperation
                    { economy: -1, security: 2, diplomacy: 0, environment: 0, approval: -2, stability: -1 } // Enforcement
                ],
                tech: [
                    { economy: -1, security: 4, diplomacy: -1, environment: 0, approval: 1, stability: 2 }, // Regulation/control
                    { economy: 2, security: 2, diplomacy: 1, environment: 0, approval: 2, stability: 3 },  // Balance/moderate
                    { economy: 4, security: -2, diplomacy: 0, environment: 0, approval: 1, stability: 1 }, // Free market/innovation
                    { economy: 1, security: 3, diplomacy: 2, environment: 0, approval: 0, stability: 2 }   // International cooperation
                ],
                economy: [
                    { economy: 6, security: 0, diplomacy: -1, environment: 0, approval: 3, stability: 4 }, // Government intervention
                    { economy: 2, security: 0, diplomacy: 1, environment: 0, approval: 1, stability: 2 },  // Moderate response
                    { economy: -2, security: 1, diplomacy: -2, environment: 0, approval: -1, stability: 0 }, // Market restrictions
                    { economy: -3, security: 0, diplomacy: 2, environment: 0, approval: -2, stability: -1 } // Free market approach
                ],
                corruption: [
                    { economy: 0, security: 1, diplomacy: 2, environment: 0, approval: 5, stability: 4 },  // Full cooperation
                    { economy: -1, security: -1, diplomacy: -2, environment: 0, approval: -3, stability: -2 }, // Resist/defend
                    { economy: 1, security: 2, diplomacy: 1, environment: 0, approval: 4, stability: 3 },  // Reform/transparency
                    { economy: -2, security: 0, diplomacy: -1, environment: 0, approval: -1, stability: -3 } // Counter-attack
                ],
                environment: [
                    { economy: -3, security: 1, diplomacy: 1, environment: 6, approval: 4, stability: 2 }, // Major intervention
                    { economy: -1, security: 0, diplomacy: 0, environment: 3, approval: 2, stability: 1 }, // Moderate response
                    { economy: 1, security: 0, diplomacy: 2, environment: 4, approval: 1, stability: 0 },  // Policy focus
                    { economy: 2, security: 0, diplomacy: -1, environment: 1, approval: -1, stability: -1 } // Minimal response
                ],
                health: [
                    { economy: -3, security: 0, diplomacy: 1, environment: 0, approval: 5, stability: 4 }, // Emergency response
                    { economy: -1, security: 1, diplomacy: 0, environment: 0, approval: 3, stability: 2 }, // Coordinate agencies
                    { economy: 0, security: 0, diplomacy: 2, environment: 0, approval: 1, stability: 1 },  // Support states
                    { economy: 1, security: 0, diplomacy: 1, environment: 0, approval: 0, stability: 0 }   // Research focus
                ]
            };
            
            // Get base impact for this category and choice
            const categoryChoices = categoryImpacts[event.category];
            if (categoryChoices && categoryChoices[choiceIndex]) {
                impact = { ...categoryChoices[choiceIndex] };
            }
            
            // Adjust based on event severity (higher severity = bigger impacts)
            const severityMultiplier = (event.severity - 5) / 4; // Convert 6-9 severity to 0.25-1.0 multiplier
            Object.keys(impact).forEach(key => {
                impact[key] = Math.round(impact[key] * (1 + severityMultiplier));
            });
            
            // Add some randomness (±1) to make outcomes less predictable
            Object.keys(impact).forEach(key => {
                impact[key] += Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
            });
            
            return impact;
        }

        function applyImpact(impact) {
            Object.keys(impact).forEach(key => {
                gameState.metrics[key] = Math.max(-100, Math.min(100, Math.round(gameState.metrics[key] + impact[key])));
            });
            updateMetricsDisplay();
        }

        function generateDetailedConsequences(choice, impact, event) {
            // Generate consequences based on event category
            const consequenceTemplates = {
                politics: [
                    "Your political maneuvering successfully navigates the crisis, demonstrating skilled leadership in a polarized environment. Congressional relationships improve, though some critics question the compromise approach.",
                    "The public response rally builds strong popular support and demonstrates executive leadership. Your approval ratings stabilize as citizens appreciate direct communication about the challenges.",
                    "Using executive authority resolves the immediate crisis but creates tensions with legislative leaders. The precedent set may limit future bipartisan cooperation.",
                    "Third-party mediation helps find common ground while preserving institutional relationships. The measured approach is praised by moderates but criticized by partisans."
                ],
                war: [
                    "Military intervention demonstrates American strength and commitment to allies. International partners provide support, though some question the escalation and long-term strategy.",
                    "Providing aid and support helps allies while avoiding direct confrontation. The measured response maintains diplomatic options while showing solidarity with partners.",
                    "Diplomatic initiatives help de-escalate tensions while preserving American interests. International mediators praise the peaceful approach, though critics worry about appearing weak.",
                    "Negotiated settlements end immediate conflicts but require ongoing monitoring. The peace process demonstrates diplomatic skill while some question the concessions made."
                ],
                immigration: [
                    "Immigration restrictions provide security but strain relationships with neighboring countries. Processing delays create humanitarian concerns while border security improves.",
                    "Expanded processing capabilities handle the crisis more humanely while maintaining security standards. International organizations praise the balanced approach.",
                    "International cooperation addresses root causes of migration while managing immediate flows. The comprehensive approach wins praise but requires ongoing resource commitments.",
                    "Enhanced enforcement demonstrates law and order but creates tensions with immigrant communities. Legal challenges to policies create ongoing uncertainty."
                ],
                tech: [
                    "Technology regulations balance innovation with security concerns. Industry leaders express mixed reactions while national security agencies support the measured approach.",
                    "Balanced policies encourage innovation while addressing legitimate concerns. The moderate approach satisfies neither extreme but builds broad coalition support.",
                    "Free market approaches accelerate technological development but raise security concerns. Innovation flourishes while regulatory gaps create potential vulnerabilities.",
                    "International cooperation on technology standards helps address global challenges while maintaining competitive advantages in key sectors."
                ],
                economy: [
                    "Government intervention stabilizes markets and prevents broader economic collapse. Investor confidence returns, though long-term fiscal impacts require careful management.",
                    "Moderate economic response provides stability without major disruption. Market confidence improves gradually while avoiding moral hazard concerns.",
                    "Market restrictions prevent immediate damage but create uncertainty about future policy direction. Some sectors benefit while others face ongoing challenges.",
                    "Free market approach allows natural corrections but results in continued volatility. Long-term economic fundamentals remain sound despite short-term pain."
                ],
                corruption: [
                    "Full cooperation with investigations demonstrates transparency and accountability. Public trust in institutions improves, though political opponents continue attacking.",
                    "Defensive responses protect executive authority but raise questions about transparency. Legal challenges continue while political damage accumulates.",
                    "Reform initiatives address systemic issues while maintaining government effectiveness. Good government groups praise reforms while implementation challenges remain.",
                    "Counter-investigations shift focus but risk appearing retaliatory. Political base approves while moderates question the confrontational approach."
                ],
                environment: [
                    "Major environmental intervention demonstrates climate leadership and saves lives. International partners praise the commitment while fiscal hawks worry about costs.",
                    "Moderate environmental response balances multiple priorities while addressing immediate needs. The pragmatic approach satisfies neither environmentalists nor industry.",
                    "Policy-focused response advances long-term environmental goals while managing immediate crisis. Environmental groups strongly support while affected communities need ongoing aid.",
                    "Minimal environmental response prioritizes economic concerns but draws criticism from scientists and international partners about inadequate climate action."
                ],
                health: [
                    "Emergency health response mobilizes resources rapidly and saves lives. Medical professionals praise the decisive action while fiscal impacts require ongoing attention.",
                    "Coordinated agency response provides effective leadership while respecting federalism. State officials appreciate support while maintaining local control.",
                    "State-focused support helps local communities while avoiding federal overreach. The decentralized approach works well in some areas but creates inconsistencies.",
                    "Research-focused response advances scientific understanding while addressing immediate needs more gradually. Long-term benefits are significant but short-term criticism persists."
                ]
            };
            
            const templates = consequenceTemplates[event.category];
            if (templates && templates.length > 0) {
                // Use choice index to select appropriate consequence, or random if out of bounds
                const templateIndex = Math.min(templates.length - 1, Math.floor(templates.length * 0.8)); // Bias toward first few options
                return templates[templateIndex] || templates[Math.floor(Math.random() * templates.length)];
            }
            
            // Fallback consequence
            return `Your decision regarding this ${event.category} crisis sets important precedent for future policy. The administration's response is carefully analyzed by experts, with reactions varying based on different stakeholder priorities and political perspectives.`;
        }

        function displayDecisionResult(choice, impact) {
            const messagesContainer = document.getElementById('messages');
            removeLastMessage(); // Remove loading message
            
            const consequences = generateDetailedConsequences(choice, impact, gameState.currentEvent);
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'message';
            resultDiv.innerHTML = `
                <div class="decision-result">
                    <div class="result-title">📊 Decision Outcome</div>
                    <div>🎯 Your Choice: ${choice}</div>
                    <div class="consequence-text">📋 ${consequences}</div>
                    <div class="impact-grid">
                        <div class="impact-item">Economy<br>${impact.economy > 0 ? '+' : ''}${Math.round(impact.economy)}</div>
                        <div class="impact-item">Security<br>${impact.security > 0 ? '+' : ''}${Math.round(impact.security)}</div>
                        <div class="impact-item">Diplomacy<br>${impact.diplomacy > 0 ? '+' : ''}${Math.round(impact.diplomacy)}</div>
                        <div class="impact-item">Environment<br>${impact.environment > 0 ? '+' : ''}${Math.round(impact.environment)}</div>
                        <div class="impact-item">Approval<br>${impact.approval > 0 ? '+' : ''}${Math.round(impact.approval)}</div>
                        <div class="impact-item">Stability<br>${impact.stability > 0 ? '+' : ''}${Math.round(impact.stability)}</div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(resultDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function endGame() {
            const finalScore = Object.values(gameState.metrics).reduce((a, b) => a + b, 0) / Object.keys(gameState.metrics).length;
            
            const messagesContainer = document.getElementById('messages');
            const gameCompleteDiv = document.createElement('div');
            gameCompleteDiv.className = 'message';
            gameCompleteDiv.innerHTML = `
                <div class="game-complete">
                    <div>🏁 PRESIDENCY COMPLETED!</div>
                    <div class="final-score">${finalScore.toFixed(1)}/100</div>
                    <div>${finalScore > 50 ? '🎉 Successful Presidency!' : finalScore > 0 ? '😐 Mixed Results' : '😬 Challenging Term'}</div>
                    <button class="restart-button" onclick="location.reload()">🔄 New Presidency</button>
                </div>
            `;
            
            messagesContainer.appendChild(gameCompleteDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.style.display = 'none';
        }

        function addLoadingMessage(text) {
            const messagesContainer = document.getElementById('messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message loading-message';
            loadingDiv.innerHTML = `<div class="loading">${text}</div>`;
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeLastMessage() {
            const messagesContainer = document.getElementById('messages');
            const lastMessage = messagesContainer.querySelector('.loading-message');
            if (lastMessage) {
                lastMessage.remove();
            }
        }

        function addErrorMessage(text) {
            const messagesContainer = document.getElementById('messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message';
            errorDiv.innerHTML = `
                <div class="event-message" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <div class="event-title">⚠️ Error</div>
                    <div class="event-description">${text}</div>
                </div>
            `;
            messagesContainer.appendChild(errorDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateMetricsDisplay() {
            Object.keys(gameState.metrics).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = Math.round(gameState.metrics[key]);
                }
            });
        }

        function updateTurnCounter() {
            document.getElementById('current-turn').textContent = gameState.turn;
        }

        function updateCharCount() {
            const textarea = document.getElementById('player-response');
            const charCount = document.getElementById('char-count');
            if (textarea && charCount) {
                charCount.textContent = textarea.value.length;
            }
        }

        function useQuickOption(option) {
            const textarea = document.getElementById('player-response');
            if (textarea) {
                textarea.value = option;
                updateCharCount();
                textarea.focus();
            }
        }

        async function submitResponse() {
            const responseText = document.getElementById('player-response').value.trim();
            if (!responseText) {
                alert('Please enter your presidential decision before submitting.');
                return;
            }

            // Display the player's message in chat format
            displayPlayerMessage(responseText);
            
            // Hide options container
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.style.display = 'none';
            
            addLoadingMessage("Processing your presidential decision...");
            
            try {
                // Call the backend API to process the decision
                const response = await fetch('/api/choice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        choice: responseText,
                        reasoning: responseText
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                removeLastMessage();
                
                // Update game state
                gameState.metrics = result.metrics;
                gameState.turn = result.turn;
                
                // Display results
                displayDecisionResult(result);
                
                // Update UI
                updateMetricsDisplay();
                updateTurnCounter();
                
                // Continue to next turn after showing results
                setTimeout(() => {
                    if (gameState.turn <= gameState.maxTurns) {
                        startNewTurn();
                    } else {
                        endGame();
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Failed to process decision:', error);
                removeLastMessage();
                addErrorMessage('Failed to process your decision. Please try again.');
                
                // Re-show options
                optionsContainer.style.display = 'block';
            }
        }

        function displayPlayerMessage(message) {
            const messagesContainer = document.getElementById('messages');
            
            const playerDiv = document.createElement('div');
            playerDiv.className = 'message';
            playerDiv.innerHTML = `
                <div class="player-message">
                    <div class="player-name">🏛️ President</div>
                    <div class="player-text">${message}</div>
                </div>
            `;
            
            messagesContainer.appendChild(playerDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function displayDecisionResult(result) {
            const messagesContainer = document.getElementById('messages');
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'message';
            resultDiv.innerHTML = `
                <div class="decision-result">
                    <div class="result-title">📊 Decision Outcome</div>
                    <div>🎯 Your Choice: ${result.choice && result.choice.option ? result.choice.option : 'Custom Decision'}</div>
                    <div class="consequence-text">📋 ${result.evaluation}</div>
                    <div class="impact-grid">
                        <div class="impact-item">Economy<br>${result.impact.economy > 0 ? '+' : ''}${Math.round(result.impact.economy)}</div>
                        <div class="impact-item">Security<br>${result.impact.security > 0 ? '+' : ''}${Math.round(result.impact.security)}</div>
                        <div class="impact-item">Diplomacy<br>${result.impact.diplomacy > 0 ? '+' : ''}${Math.round(result.impact.diplomacy)}</div>
                        <div class="impact-item">Environment<br>${result.impact.environment > 0 ? '+' : ''}${Math.round(result.impact.environment)}</div>
                        <div class="impact-item">Approval<br>${result.impact.approval > 0 ? '+' : ''}${Math.round(result.impact.approval)}</div>
                        <div class="impact-item">Stability<br>${result.impact.stability > 0 ? '+' : ''}${Math.round(result.impact.stability)}</div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(resultDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function displayOptions(event) {
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.style.display = 'block';
            optionsContainer.innerHTML = `
                <div class="input-container">
                    <div class="input-title">🎯 Your Presidential Response</div>
                    <textarea 
                        id="player-response"
                        class="response-input"
                        placeholder="Describe your presidential decision and reasoning. Consider the advice from your advisors and the potential consequences..."
                        maxlength="500"
                        oninput="updateCharCount()">
                    </textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span id="char-count" style="font-size: 12px; color: #6c757d;">0</span>
                        <span style="font-size: 12px; color: #6c757d;">/500 characters</span>
                    </div>
                    <button class="submit-button" onclick="submitResponse()">
                        📋 Submit Presidential Decision
                    </button>
                    
                    <div class="suggested-options">
                        <h4>💡 Quick Response Options</h4>
                        ${event.options.map(option => `
                            <span class="quick-option" onclick="useQuickOption('${option}')">${option}</span>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Focus on the textarea
            setTimeout(() => {
                const textarea = document.getElementById('player-response');
                if (textarea) {
                    textarea.focus();
                    
                    // Add Enter key support (Ctrl+Enter or Cmd+Enter to submit)
                    textarea.addEventListener('keydown', function(e) {
                        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                            submitResponse();
                        }
                    });
                }
            }, 100);
        }

        function addLoadingMessage(text) {
            const messagesContainer = document.getElementById('messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message loading-message';
            loadingDiv.innerHTML = `<div class="loading">${text}</div>`;
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeLastMessage() {
            const messagesContainer = document.getElementById('messages');
            const lastMessage = messagesContainer.querySelector('.loading-message');
            if (lastMessage) {
                lastMessage.remove();
            }
        }

        function updateMetricsDisplay() {
            Object.keys(gameState.metrics).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = Math.round(gameState.metrics[key]);
                }
            });
        }

        function updateTurnCounter() {
            document.getElementById('current-turn').textContent = gameState.turn;
        }
    </script>
</body>
</html>
